---
layout: default
title: Authentication
parent: HTTP API
nav_order: 80
---

# Authentication
{:.no_toc}

HTTP API of machbase-neo supports the token based authentication.
Enable it by specifying `--http-enable-token-auth true` command line option or set `EnableTokenAuth = true` in the config file. When you launching server with the option, all HTTP API invocations requires `Authorization` header with pre-registered token.

```
machbase-neo serve --http-enable-token-auth true
```

Starting log shows HTTP token authentication is enabled.

```
......
2023/02/20 20:14:29.878 INFO  neo neosvr           HTTP token authentication enabled
2023/02/20 20:14:29.878 INFO  neo neosvr           HTTP Listen tcp://127.0.0.1:5654
......
```

1. TOC
{:toc}

## Generates Client Token

The subcommand `machbase-neo shell key` manages client keys and tokens.

**List registered client authentication keys and tokens**

```
machbase-neo shell key list
```

List all pre-registered client-id and validation periods.

```
$ machbase-neo shell key list
┌────────┬──────────────────────┬───────────────────────────────┬───────────────────────────────┐
│ ROWNUM │ ID                   │ VALID FROM                    │ EXPIRE                        │
├────────┼──────────────────────┼───────────────────────────────┼───────────────────────────────┤
│      1 │ myid2                │ 2023-02-05 01:55:18 +0000 UTC │ 2033-02-02 01:55:18 +0000 UTC │
│      2 │ myid3                │ 2023-02-05 01:56:36 +0000 UTC │ 2033-02-02 01:56:36 +0000 UTC │
......
```

**Delete an existing client authentication key and token**

```
machbase-neo shell key del <client-id>
```

```
$ machbase-neo shell key del myid2
deleted
```

**Register new client authentication keys and tokens**

`machbase-neo shell key gen` subcommand generates new key pair and token for the given client-id.
It writes keys and token into the file that you specfiy by `--output` option.

```
machbase-neo shell key gen <client-id> --output <output_file>
```

Generate and register new key for the client-id `http-api-app01`. It stores the generated key and token to the `*_cert.pem`, `*_key.pem` and `_token` file.

```
$ machbase-neo shell key gen http-api-app01 --output ./http-api-app01 
Save certificate ./http-api-app01_cert.pem
Save private key ./http-api-app01_key.pem
Save token ./http-api-app01_token
```

Check the generated files.

```
$ ls -al http-api-app01*
-rw-r--r--  1 eirny  staff  782 Feb 20 19:33 ./tmp/http-api-app01_cert.pem
-rw-------  1 eirny  staff  390 Feb 20 19:33 ./tmp/http-api-app01_key.pem
-rw-------  1 eirny  staff   81 Feb 20 19:33 ./tmp/http-api-app01_token
```

The files `*_cert.pem` and `*_key.pem` are for the X.509 based authentication in other use cases.

For the token based authentication, see the content of the `*_token` file.

```
$ cat ./http-api-app01_token 
http-api-app01:b:d59310703c1ebf627f8b781fb50437326ec65b067257ebc72f07b12846761d17   
```

## Authorization Header

Let's use the token for API authentication. Set `Authorization` bearer header with the content of token file.

```
curl --output - http://127.0.0.1:5654/db/query \
    --data-urlencode "q=select * from EXAMPLE limit 2" \
    -H "Authorization: Bearer `cat ./http-api-app01_token`"
```

```json
{
  "data": {
    "columns": [ "NAME", "TIME", "VALUE" ],
    "types": [ "string", "datetime", "double" ],
    "rows": [
      [ "wave.sin", 1675851592000000000, 0 ],
      [ "wave.cos", 1675851592000000000, 1 ]
    ]
  },
  "success": true,
  "reason": "success",
  "elapse": "1.866708ms"
}
```

Let's try without the `Authroization` header, or wrong token.

```
curl --output - http://127.0.0.1:5654/db/query \
    --data-urlencode "q=select * from EXAMPLE limit 2" \
    -H "Authorization: Bearer http-api-app01:b:intended-wrong-value"
```

If client provides an invalid token, the server responses `HTTP/1.1 401 Unauthorized` with an error json message below.

```json
{"success":false,"reason":"invalid token"}
```