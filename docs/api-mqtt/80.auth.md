---
layout: default
title: Authentication
parent: MQTT API
nav_order: 80
---

# MQTT Authentication
{:.no_toc}

1. TOC
{:toc}

## Generate Client Token and X.509 Certificate

The subcommand `machbase-neo shell key` manages client keys and tokens.

**List registered client authentication keys and tokens**

```
machbase-neo shell key list
```

List all pre-registered client-id and validation periods.

```
$ machbase-neo shell key list
┌────────┬──────────────────────┬───────────────────────────────┬───────────────────────────────┐
│ ROWNUM │ ID                   │ VALID FROM                    │ EXPIRE                        │
├────────┼──────────────────────┼───────────────────────────────┼───────────────────────────────┤
│      1 │ myid2                │ 2023-02-05 01:55:18 +0000 UTC │ 2033-02-02 01:55:18 +0000 UTC │
│      2 │ myid3                │ 2023-02-05 01:56:36 +0000 UTC │ 2033-02-02 01:56:36 +0000 UTC │
......
```

**Delete an existing client authentication key and token**

```
machbase-neo shell key del <client-id>
```

```
$ machbase-neo shell key del myid2
deleted
```

**Register new client authentication keys and tokens**

`machbase-neo shell key gen` subcommand generates new key pair and token for the given client-id.
It writes keys and token into the file that you specfiy by `--output` option.

```
machbase-neo shell key gen <client-id> --output <output_file>
```

Generate and register new key for the client-id `http-api-app01`. It stores the generated key and token to the `*_cert.pem`, `*_key.pem` and `*_token` file.

```
$ machbase-neo shell key gen mqtt-api-app01 --output ./mqtt-api-app01 
Save certificate ./mqtt-api-app01_cert.pem
Save private key ./mqtt-api-app01_key.pem
Save token ./mqtt-api-app01_token
```

Check the generated files.

```
$ ls -al mqtt-api-app01*
-rw-r--r--@ 1 eirny  staff  786 Feb 21 13:53 mqtt-api-app01_cert.pem
-rw-------@ 1 eirny  staff  390 Feb 21 13:53 mqtt-api-app01_key.pem
-rw-------@ 1 eirny  staff   81 Feb 21 13:53 mqtt-api-app01_token
```

- `*_cert.pem` file is the X.509 certificate for the client which is signed by the server.
- `*_key.pem` file is the private key for the client.
- `*_token` file contains token string for the client.

The files `*_cert.pem` and `*_key.pem` will be used for the TLS connection and X.509 based authentication.

For the token based authentication, see the content of the `*_token` file.

```
$ cat ./mqtt-api-app01_token 
mqtt-api-app01:b:ac49df38ba3371fb1a78867b1ac6e117e40ed91aa70a27ff3c55faae7d28983b
```

## Token based authentication

MQTT API of machbase-neo supports the token based authentication.
Enable it by specifying `--mqtt-enable-token-auth true` command line option or set `EnableTokenAuth = true` in the config file. When you launching server with this option, MQTT CONNECT message requires `client-id`, `username` with pre-registered id and token.

```
machbase-neo serve --mqtt-enable-token-auth true
```

The starting log shows MQTT token authentication is enabled.

```
......
2023/02/21 13:43:11.178 INFO  neosvr           MQTT token authentication enabled
2023/02/21 13:43:11.180 INFO  mqtt-tcp         MQTT Listen tcp://127.0.0.1:5653
......
```

### CONNECT with token

Apply registered client-id on `client-id` and set token in `username` of CONNECT message.
Do not set any value in `password`.

```
mosquitto_pub -h 127.0.0.1 -p 5653 \
    --id mqtt-api-app01            \
    --username `cat ./mqtt-api-app01_token` \
    -t db/write/EXAMPLE            \
    -m '[ "wave.pi", `date +%s000000000`, 3.1415]'
```

If a client doesn't set `client-id` and `username` properly, the server rejects the CONNECT messages.

```
mosquitto_pub -h 127.0.0.1 -p 5653 -t db/write/EXAMPLE \
    -m '[ "wave.pi", `date +%s000000000`, 3.1415]'

Connection error: Connection Refused: not authorised.
Error: The connection was refused.
```

## X.509 based authentication

When machbase-neo starts with `--mqtt-enable-tls true` command line option or set `Tls.Enabled = true` in the configurationfile, machbase-neo accepts TLS (a.k.a SSL) connecions from clients. If TLS is enabled, it ignores token based authentication and accepts only connection that finished ssl-handshaking successfully with pre-registered X.509 certificates.

{:.note}
> When X.509 is applied, machbase-neo mqtt server ignores `username` and `passowrd` fields of CONNECT message. Do not specify those values. But still need to set `client-id` for the clarity.

A client should use the pre-registered client-id and token those were generated as the above section. Apply client-id for the `client-id` of CONNECT message and do not set the `username` and `password`.

```sh
mosquitto_pub -h 127.0.0.1 -p 5653 \
    --id mqtt-api-app01            \
    --cafile ~/.config/machbase/cert/machbase_cert.pem --insecure \
    --cert ./tmp/mqtt-api-app01_cert.pem \
    --key ./tmp/mqtt-api-app01_key.pem \
    -t db/write/EXAMPLE            \
    -m '[ "wave.pi", `date +%s000000000`, 3.1415]'
```