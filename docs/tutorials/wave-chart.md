---
parent: Tutorials
title: Wave data and monitoring
layout: default
---
# Wave data and monitoring

## Run machbase-neo server

Start machbase-neo server.

```sh
machbase-neo serve
```

## Create example table

Create `EXAMPLE` table for this course if it doesn't exist.

```sh
machbase-neo shell "create tag table EXAMPLE (name varchar(100) primary key, time datetime basetime, value double)"
```

You could delete the table when you've done with it.

```sh
machbase-neo shell "drop table EXAMPLE"
```

## Make waves

We are going to cover serveral different ways how to write data into Machbase-neo through this tutorial.

- [x] Shell script using `machbase-neo shell` command
- [ ] Python client program writing data via HTTP API.
- [x] Go client program writing data via HTTP API.
- [x] Go client program writing data via gRPC API.

### Writing data with shell script using `machbase-neo shell`

The easiest way writing data into machbase-neo is using its command line tool `machbase-neo shell`.
We can import/export/read table with it.

#### Step 1. Data generator

For demonstration, we prepares simple shell script that prints out sine/cosine values per a second.

Copy script below and save it as `script_wave.sh`

```sh
#!/bin/bash
angle=0
step_angle=24
sinval=0
cosval=0
PI=3.14159

while [ 1 ]
do
    ts=`date +"%s"`
    sinval=$(awk "BEGIN{ printf \"%.6f\", (sin($angle*($PI/180)))}")
    cosval=$(awk "BEGIN{ printf \"%.6f\", (cos($angle*($PI/180)))}")
    echo "wave.sin,$ts,$sinval"
    echo "wave.cos,$ts,$cosval"
    sleep 1
    angle=$((angle+step_angle))
done
```

#### Step 2. Run script 

Let's run this script for testing.

```sh
sh ./script_save.sh
```

It periodically prints sin/cos values with name (`wave.sin`, `wave.cos`), UNIX epoch time and value per a second as below.
The output is in csv and it is intended to utilize `machbase-neo shell` command.

```cs
wave.sin,1674815646,0.000000
wave.cos,1674815646,1.000000
wave.sin,1674815647,0.406736
wave.cos,1674815647,0.913546
wave.sin,1674815648,0.743144
wave.cos,1674815648,0.669131
```

Press `^C` to stop shell script.

#### Step 3. Combine script with `machbase-neo shell`

Now we can use the output of the script for input of `machbase-neo shell`.

```sh
sh wave.sh | machbase-neo shell import --timeformat=s EXAMPLE
```
{{: .note }}

> Since machbase-neo treats all timestamp in nanoseconds,
> but shell script generates timestamp in seconds by `time` shell command.
> It is required explicitly announce to machbase-neo 
> that incoming timestamp of csv data
> is in seconds time precision by `--timeformat`

CSV lines that are generated by shell script are being processed in `machbase-neo shell import` then "import" into `EXAMPLE` table.

### Go client program writing data via HTTP

If you are a Go programmer and prefer to write RESTful API client, this is the way to go.

#### Step 1.

Find [full source code from github]({{ site.examples_url }}/go/http_wave/http_wave.go)

#### Step 2.

Copy source code and save it as `http_wave.go` or just run script below

```sh
curl -o http_wave.go "https://raw.githubusercontent.com/machbase/machbase/main/examples/go/http_wave/http_wave.go"
```

#### Step 3.

```sh
go run http_wave.go
```

This Go code generates sine & cosine wave data and writes them into EXAMPLE table.

#### Code explains

Define data structure that represents the payload of write API.

```go
type WriteReq struct {
    Table string       `json:"table"`
    Data  WriteReqData `json:"data"`
}

type WriteReqData struct {
    Columns []string `json:"columns"`
    Rows    [][]any  `json:"rows"`
}
```

The API for writing data via HTTP is explained in [here](/machbase/docs/api-http/write) 
and it expects to receive JSON payload.

We can prepare payload like below code, so that write multiple records within a payload.
Assume `sin`, `cos` variables are properly initialized `float64` values.

```go
content, _ := json.Marshal(&WriteReq{
    Table: "EXAMPLE",
    Data: WriteReqData{
        Columns: []string{"name", "time", "value"},
        Rows: [][]any{
            {"wave.sin", ts.UTC().UnixNano(), sin},
            {"wave.cos", ts.UTC().UnixNano(), cos},
        },
    },
})
```

It will be encoded as JSON for writing API like below.


```json
{
    "table": "EXAMPLE",
    "data": {
        "columns":["name", "time", "value"],
        "rows": [
            [ "wave.sin", 1670380342000000000, 1.1 ],
            [ "wave.cos", 1670380343000000000, 2.2 ]
        ]
    }
}
```

Send it to server via http POST request.

```go
client := http.Client{}
rsp, err := client.Post("http://127.0.0.1:5654/db/write", 
    "application/json", bytes.NewBuffer(content))
```

Server replies `HTTP 200 OK` if it successfully writes data.

### Go client program writing data via gRPC

gRPC version of wave generator example is also available.
Since it doesn't need to define custom data structures for payload,
relatively less lines of code are needed comparing to HTTP.

#### Step 1.

Find [full source code from github]({{ site.examples_url }}/go/grpc_wave/grpc_wave.go)

#### Step 2.

Create directory `grpc_wave`

```sh
mkdir grpc_wave && cd grpc_wave
```

#### Step 3.

Copy source code and save it as `grpc_wave.go` or run script below in the directory.

```sh
curl -o grpc_wave.go "https://raw.githubusercontent.com/machbase/machbase/main/examples/go/grpc_wave/grpc_wave.go"
```

#### Step 4.

Initialize go mod and prepare dependent modules.

```sh
go mod init wave && go mod tidy
```

#### Step 5. Run

```sh
go run .
```

## Watch waves

Since we learned various ways to to write data, it's time to know how we can "watch" the data that we collect.

- [x] Graph on terminal
- [X] Table view on terminal
- [x] Generate chart HTML 
- [ ] Using Grapana plugin for Machbase-neo

### Graph on terminal

Use machabse-neo shell, it provides simple command line tool for monitoring incoming data.

```sh
machbase-neo shell chart --range 30s EXAMPLE/wave.sin#value EXAMPLE/wave.cos#value
```

![img](chart01.jpg)

### Table view on terminal

It is also possible browsing table data forward/backward with "walk" command like below.

```sh
machbase-neo shell walk "select * from EXAMPLE order by time desc"
```

![img](chart02.jpg)

{: .note }

> Machbase treats all time data in UTC as default.
> Use `--tz` option with shell command to display time in a time-zone other than 'UTC'. 
> This option accepts 'local' and tz database format (eg: 'Europe/Paris').
> 
> 
> `machbase-neo shell --tz=local walk select...`
>
> `machbase-neo shell --tz=America/Los_Angeles walk select...`

### Generate chart HTML

Command below generates `chart.html` file that contains a chart.

Execute it and open output html file with your web browser.

```sh
machbase-neo shell chart \
    --range 1m --count 1 \
    --output chart.html --format html \
    --html-title "Let's make waves" \
    EXAMPLE/wave.sin
```

This command generates HTML page like below.

![img](chart-html.jpg)

